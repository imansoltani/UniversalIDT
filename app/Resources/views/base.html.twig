<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7 isIE"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie7 isIE"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie8 isIE"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js notIe" lang="{{ app.request.locale }}"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title '' %}</title>
    {% block headers %}{% endblock headers %}
    {% block stylesheets %}{% endblock stylesheets %}
</head>
<body {% block body_attr '' %}>
<!--[if lt IE 7]>
<p class="chromeframe">You are using an <strong>outdated</strong> browser.
    Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
<![endif]-->

<div id="user">
    {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
        {{ 'layout.logged_in_as'|trans({'%username%': app.user.username}, 'FOSUserBundle') }} |
        <a href="{{ path('fos_user_profile_show') }}">Profile</a>
        <a href="{{ path('fos_user_security_logout') }}">{{ 'layout.logout'|trans({}, 'FOSUserBundle') }}</a>
    {% else %}
        <a href="{{ path('fos_user_security_login') }}">{{ 'layout.login'|trans({}, 'FOSUserBundle') }}</a>
        <a href="{{ path('fos_user_registration_register') }}">{{ 'layout.register'|trans({}, 'FOSUserBundle') }}</a>
    {% endif %}
</div>
<div id="menu">
    <a href="{{ path('WebPage_main') }}">Home</a>
    <a href="{{ path('WebPage_calling_cards') }}">Calling Cards</a>
    {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
        <a href="{{ path('user_my_pins') }}">My PINs</a>
        <a href="{{ path('user_billing_history') }}">Billing history</a>
    {% endif %}
    <a href="{{ path('WebPage_rates') }}">Rates</a>
    <a href="#">Applications</a>
    <a href="#">About Us</a>
    <a href="#">Customer Service</a>
    <a href="{{ path('WebPage_basket') }}">Basket</a>

</div>
Current cart totals: <span id="cart_total">--</span> for <span id="cart_total_items">--</span> items!

{% for type, messages in app.session.flashbag.all() %}
    {% for message in messages %}
        <div class="flash-{{ type }}">
            {{ message }}
        </div>
    {% endfor %}
{% endfor %}

{% block body %}{% endblock %}

<script src="{{ asset('bundles/universalidt/js/jquery-1.11.2.min.js') }}" type="text/javascript"></script>
<script type="text/javascript" src="{{ asset('bundles/universalidt/js/jquery.cookie.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/universalidt/js/json2.js') }}"></script>
<script type="text/javascript">
    var selected_products = [];

    var selected_products_currency = "";

    function cookieClear() {
        selected_products = [];
        $.cookie("products", "[]", { path: '/' });

        selected_products_currency = "";
        $.cookie("products_currency", "", { path: '/' });
    }

    function loadSelectedProducts() {
        var products_json = $.cookie("products");
        selected_products = products_json == undefined ? [] : JSON.parse(products_json);

        selected_products_currency = $.cookie("products_currency") == undefined ? "" : $.cookie("products_currency");

        var valid = true;
        var types = ["buy", "recharge"];
        for(var product in selected_products) {
            if(     selected_products[product]['product'] == undefined ||
                    selected_products[product]['count'] == undefined ||
                    selected_products[product]['denomination'] == undefined ||
                    types.indexOf(selected_products[product]['type']) == -1
            ){
                valid = false;
                break;
            }
        }

        if(!valid)
            cookieClear();
    }

    function updateCounts() {
        var total_count = 0;
        for(var product in selected_products)
            total_count += parseInt(selected_products[product]['count']);

        $("#cart_total_items").html(total_count == 0 ? 0 : selected_products.length);
        $("#cart_total").html(total_count);
    }

    function addToCookie(_product_id, _denomination, _count, _currency, _type) {
        if(selected_products_currency != "" && selected_products_currency != _currency) {
            alert('You must select carts with same currency.');
            return;
        }
        else if(selected_products_currency == "") {
            selected_products_currency = _currency;
            $.cookie("products_currency", _currency, { path: '/' });
        }

//                alert('product:'+_product_id+' count:'+_count+' denomination:'+_denomination+' type:'+_type);
        var _exist = false;
        for(var product in selected_products) {
            if(     +selected_products[product]['product'] == +_product_id &&
                    +selected_products[product]['denomination'] == +_denomination &&
                    selected_products[product]['type'] == _type
            ){
                selected_products[product]['count'] = +selected_products[product]['count'] + +_count;
                _exist = true;
                break;
            }
        }

        if(!_exist)
            selected_products.push({'product':+_product_id, 'count':+_count, 'denomination':+_denomination, 'type':_type});

        var new_products_json = JSON.stringify(selected_products);

        $.cookie("products", new_products_json, { path: '/' });
        updateCounts();
    }

    $(document).ready(function(){
        loadSelectedProducts();
        updateCounts();
    });
</script>
{% block javascripts %}{% endblock %}
</body>
</html>
