<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7 isIE"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie7 isIE"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie8 isIE"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js notIe" lang="{{ app.request.locale }}"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title '' %}</title>
    {% block headers %}{% endblock headers %}
    {% block stylesheets %}{% endblock stylesheets %}
    <link href="{{ asset("bundles/universalidt/js/plugins/msgGrowl/css/msgGrowl.css") }}" rel="stylesheet">
</head>
<body {% block body_attr '' %}>
<!--[if lt IE 7]>
<p class="chromeframe">You are using an <strong>outdated</strong> browser.
    Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
<![endif]-->

{% block body %}{% endblock %}

{% block javascripts %}{% endblock %}

<script type="text/javascript" src="{{ asset('bundles/universalidt/js/jquery.cookie.js') }}"></script>
<script type="text/javascript" src="{{ asset('bundles/universalidt/js/json2.js') }}"></script>
<script type="text/javascript" src="{{ asset("bundles/universalidt/js/plugins/msgGrowl/js/msgGrowl.js") }}"></script>
<script type="text/javascript">
    $(document).ready(function () {
    {% for type, messages in app.session.flashbag.all() %}
        {% for message in messages %}
            $.msgGrowl ({
                type: '{{ type }}',
                title: 'Message',
                text: '{{ message }}'
            });
        {% endfor %}
    {% endfor %}
    });
</script>
<script type="text/javascript">
    var selected_products = [];

    var selected_products_currency = "";

    function cookieClear() {
        selected_products = [];
        $.cookie("products", "[]", { path: '/' });

        selected_products_currency = "";
        $.cookie("products_currency", "", { path: '/' });
    }

    function loadSelectedProducts() {
        var products_json = $.cookie("products");
        selected_products = products_json == undefined ? [] : JSON.parse(products_json);

        selected_products_currency = $.cookie("products_currency") == undefined ? "" : $.cookie("products_currency");

        var valid = true;
        var types = ["buy", "recharge"];
        for(var product in selected_products) {
            if(     selected_products[product]['id'] == undefined ||
                    selected_products[product]['name'] == undefined ||
                    selected_products[product]['image'] == undefined ||
                    selected_products[product]['count'] == undefined ||
                    selected_products[product]['denomination'] == undefined ||
                    types.indexOf(selected_products[product]['type']) == -1
            ){
                valid = false;
                break;
            }
        }

        if(!valid) {
            cookieClear();
            $.msgGrowl ({
                type: "error",
                title: "Cookie is invalid",
                text: 'Basket cleared.'
            });
        }

//            console.log(selected_products);
    }

    function updateCounts() {
        var total_count = 0;
        for(var product in selected_products)
            total_count += parseInt(selected_products[product]['count']);

//            $("#cart_total_items").html(selected_products.length);//total_count == 0 ? 0 : selected_products.length);
        $("#cart_total_items").html(total_count);

        if (typeof updateBasketTable == 'function') {
            updateBasketTable();
        }
    }

    function addToCookie(_id, _name, _image, _denomination, _count, _currency, _type) {
        if(selected_products_currency != "" && selected_products_currency != _currency) {
            $.msgGrowl ({
                type: "warning",
                title: "Currency Error",
                text: ('You must select carts with same currency. this='+_currency+ ' basket='+selected_products_currency)
            });
            return;
        }
        else if(selected_products_currency == "") {
            selected_products_currency = _currency;
            $.cookie("products_currency", _currency, { path: '/' });
        }

//                alert('product:'+_product_id+' count:'+_count+' denomination:'+_denomination+' type:'+_type);
        var _exist = false;
        for(var product in selected_products) {
            if(     +selected_products[product]['id'] == +_id &&
                    +selected_products[product]['denomination'] == +_denomination &&
                    selected_products[product]['type'] == _type
            ){
                selected_products[product]['count'] = +selected_products[product]['count'] + +_count;
                _exist = true;
                break;
            }
        }

        if(!_exist)
            selected_products.push({'id':+_id, 'name':_name, 'image':_image, 'denomination':+_denomination, 'count':+_count, 'type':_type});

//            console.log(selected_products);

        var new_products_json = JSON.stringify(selected_products);

        $.cookie("products", new_products_json, { path: '/' });
        $.msgGrowl ({
            type: "success",
            title: "Added to Cart",
            text: 'Item successfully added to your cart.'
        });
        updateCounts();
    }

    loadSelectedProducts();
    updateCounts();
</script>
</body>
</html>
